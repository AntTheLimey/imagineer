name: CI - Client

on:
    push:
        branches: [ main, master ]
        paths:
            - 'client/**'
            - '.github/workflows/ci-client.yml'
    pull_request:
        branches: [ main, master ]
        paths:
            - 'client/**'
            - '.github/workflows/ci-client.yml'

jobs:
    client:
        name: Client (Node.js ${{ matrix.node-version }})
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: ['20', '22']
            fail-fast: false

        defaults:
            run:
                working-directory: client

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  cache-dependency-path: client/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint

            - name: Run tests
              run: npm test

            - name: Run tests with coverage
              if: matrix.node-version == '20'
              run: npm run test:coverage

            - name: Build client
              run: npm run build

            - name: Verify build output
              run: |
                  ls -lh dist/
                  echo "Build completed successfully"

            - name: Upload build artifact
              if: matrix.node-version == '20'
              uses: actions/upload-artifact@v4
              with:
                  name: imagineer-client-dist
                  path: client/dist/
                  retention-days: 7

            - name: Upload coverage artifact
              if: matrix.node-version == '20'
              uses: actions/upload-artifact@v4
              with:
                  name: client-coverage
                  path: client/coverage/
                  retention-days: 7
