services:
  ollama:
    build:
      context: ./docker/ollama
      dockerfile: Dockerfile
    container_name: imagineer-ollama
    ports:
      - "11434:11434"
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 15s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - imagineer-network

  postgres:
    build:
      context: .
      dockerfile: docker/postgres/Dockerfile
      additional_contexts:
        vectorizer: ../pgedge-vectorizer
    container_name: imagineer-postgres
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - POSTGRES_USER=imagineer
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=imagineer
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/db-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    command: >
      postgres
      -c shared_preload_libraries=pg_cron,pg_tokenizer,pgedge_vectorizer
      -c cron.database_name=imagineer
      -c listen_addresses='*'
      -c pgedge_vectorizer.provider='ollama'
      -c pgedge_vectorizer.api_url='http://ollama:11434'
      -c pgedge_vectorizer.model='mxbai-embed-large'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imagineer -d imagineer"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - imagineer-network

  mcp-server:
    build:
      context: ../pgedge-postgres-mcp
      dockerfile: Dockerfile.server
    container_name: imagineer-mcp
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - PGHOST=postgres
      - PGPORT=5432
      - PGDATABASE=imagineer
      - PGUSER=imagineer
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - PGEDGE_LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - INIT_TOKENS=imagineer-dev-token
    volumes:
      - ./config/mcp:/app/config:ro
    ports:
      - "8080:8080"
    command: ["-http", "-addr", ":8080"]
    restart: unless-stopped
    networks:
      - imagineer-network

networks:
  imagineer-network:
    driver: bridge
